# Dev Container for VS Code with Podman
# Base: Ubuntu 24.04 LTS
FROM docker.io/library/ubuntu:24.04

ARG USERNAME=developer
ARG USER_UID=1000
ARG USER_GID=1000

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Install base packages and dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Essential tools
    curl \
    wget \
    git \
    ca-certificates \
    gnupg \
    lsb-release \
    sudo \
    locales \
    tzdata \
    # Build essentials (needed for native modules)
    build-essential \
    pkg-config \
    libssl-dev \
    # Python
    python3 \
    python3-pip \
    python3-venv \
    python3-dev \
    # Editor and terminal utilities
    vim \
    nano \
    less \
    htop \
    jq \
    unzip \
    zip \
    # SSH client
    openssh-client \
    && rm -rf /var/lib/apt/lists/*

# Set up locale
RUN locale-gen en_US.UTF-8
ENV LANG=en_US.UTF-8
ENV LANGUAGE=en_US:en
ENV LC_ALL=en_US.UTF-8

# Install Node.js 22.x LTS
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install R via r-rig
RUN curl -L https://rig.r-pkg.org/deb/rig.gpg -o /etc/apt/trusted.gpg.d/rig.gpg \
    && echo "deb http://rig.r-pkg.org/deb rig main" > /etc/apt/sources.list.d/rig.list \
    && apt-get update \
    && apt-get install -y r-rig \
    && rm -rf /var/lib/apt/lists/* \
    && rig add release \
    && rig default release

# Create non-root user with sudo access
RUN groupadd --gid ${USER_GID} ${USERNAME} \
    && useradd --uid ${USER_UID} --gid ${USER_GID} -m ${USERNAME} \
    && echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/${USERNAME} \
    && chmod 0440 /etc/sudoers.d/${USERNAME}

# Switch to non-root user for remaining installations
USER ${USERNAME}
WORKDIR /home/${USERNAME}

# Install Rust (as user)
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/home/${USERNAME}/.cargo/bin:${PATH}"

# Install GitHub Copilot CLI
RUN curl -fsSL https://gh.io/copilot-install | bash

# Install Claude Code
RUN curl -fsSL https://claude.ai/install.sh | bash

# Install Mistral Vibe
RUN curl -LsSf https://mistral.ai/vibe/install.sh | bash

# Set up PATH for all installed tools (container processes)
ENV PATH="/home/${USERNAME}/.local/bin:/home/${USERNAME}/.cargo/bin:${PATH}"

# Configure PATH in shell profile for interactive sessions
RUN echo 'export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"' >> ~/.bashrc \
    && echo 'source "$HOME/.local/bin/env" 2>/dev/null || true' >> ~/.bashrc

# Create workspace directory (will be mounted from host)
RUN mkdir -p /home/${USERNAME}/devmachine

# Default working directory
WORKDIR /home/${USERNAME}/devmachine

# Keep container running (for VS Code attach)
CMD ["sleep", "infinity"]
